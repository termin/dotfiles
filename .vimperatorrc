"2.2 (created: 2009/10/28 19:04:27)
" for Mac

" ----- notice -----
" set!はFirefoxの設定を変える
" setはvimperatorの設定
" らしい.

" Loading
echo "vimp: We'll back soon..."

" ----- main options -----
set runtimepath=/Users/termin/.vimperator
source! /Users/termin/.vimperatorrc.local

set guioptions=rbT

" ブラウザタイトルの変更
" set titlestring=vimp
" ページ全体で検索語を強調表示
set hlsearch
" 検索語の大文字小文字を無視
" set ignorecase

"ビープ音を鳴らさずビジュアルベルを使用
set visualbell
"ビジュアルベルを無効化
hi Bell display: none;

" 新しいタブで開く
" all			All commands
" addons		:addo[ns] command
" downloads		:downl[oads] command
" extoptions	:exto[ptions] command
" help			:h[elp] command
" javascript	:javascript! or :js! command
" prefs			:pref[erences]! or :prefs! command
set newtab=all
" exモード時でインクリメント補完
set wildoptions=auto
" input要素にfocusを奪われないようにする
" AwesomeBarを使いたい場合に、フォーカスがvimpに取られてしまうと扱いにくいので通常はoff
" set focuscontent

" Items which are completed at the :open prompts. Available items:
" default: slf
" s Search engines and keyword URLs 
" f Local files 
" l Firefox location bar entries (bookmarks and history sorted in an intelligent way) 
" b Bookmarks 
" h History 
" S Search engine suggestions 
" t Open tabs
set complete=slS
" リンク先の表示位置
set showstatuslinks=2
"Awesomebarの補完対象にBookmarkletを追加、件数を50件に変更
" set! browser.urlbar.filter.javascript=false
" set! browser.urlbar.maxRichResults=50 

" ----- Key Mappings -----
" 今は適当に割り当てているだけだけど, その内出来るところは整理したい.
" let mapleader=","

" travian
:map <M-C-t> :open http://s4.travian.jp/build.php?z=351133&gid=17<CR>
:nmap ,f ft
" show current website with a minimal style sheet.
noremap ! :set usermode<CR>

" <M-A-Left>/<M-A-Right>かh/lでタブ移動
map <M-A-Left> <C-p>
map <M-A-Right> <C-n>
nmap h <C-p>
nmap l <C-n>
"<S-M-Left>/<S-M-Right>で現在のタブの位置変更
map <S-M-Left>  :tabmove! -1<CR>:echo "うごうご・・・！"<CR>
map <S-M-Right> :tabmove! +1<CR>:echo "うごうご・・・！"<CR>
" <M-f>でvimpによる検索/
map <M-f> /
" tumblrでtキーを使う為, Tで代用する
"map T :tabopen<Space>
" <M-i>でinput fieldにフォーカス
nmap e gi
" URL中の数字を++/--
noremap ++ <C-a>
noremap -- <C-x>
" d キーでも直前にフォーカスしていたタブに戻る様にする
noremap <C-w> <M-w>
map d <C-w>
" undo一覧から開く
map U :undo<Space>
map ,s :saves<CR>
" .vimperatorrcをリロード.
" mapcだけじゃ全てのmappingがクリアされないみたい. 追試済み (http://d.hatena.ne.jp/blooo/20100120/1263963525)
" nnoremap <silent> ,r :mapc<CR>:cmapc<CR>:imapc<CR>:so ~/.vimperatorrc<CR>
nnoremap ,r :mapc<CR>:cmapc<CR>:imapc<CR>:so ~/.vimperatorrc<CR>

" colorscheme (http://coderepos.org/share/browser/lang/javascript/vimperator-plugins/trunk/colors/)
" colorscheme sweets_snaka
" colorscheme sweets
" colorscheme default
" colorscheme simple
colorscheme vimplight

" ----- Plugin Options  -----
" (http://coderepos.org/share/browser/dotfiles/vimperator/retlet-vimperatorrc?rev=)
" trunk以外にbranches/2.xからも欲しい時はどう指定すれば良いのだろう
" let g:plugin_loader_roots = "~/.vimperator/plugin-test/"
" let g:plugin_loader_plugins = "_libly,bitly,char-hints-mod2,copy,exopen,feedSomeKeys_2,imageextender,ldrize_cooperation,localkeymode,migratestatusbar,multi_requester,no-reading,pluginManager,removetabs,sl,stella,tabsort,toggler,walk-input,yetmappings"

"<C-Del>で検索語の強調表示をトグル(toggleHighlight.js)
"map <C-Del> :toggleHighlight<CR>
"<A-g>でGreasemonkeyをトグル(gmperator.js)
"map <A-g> :gmset!<CR>

" copy.js
"<C-S-c>でタイトルとURLをコピー(copy.js)
map <M-S-c> :copy titleAndURL<CR>
map cp :copy<Space>
js <<EOM
liberator.globalVariables.copy_templates = [
  { label: 'titleAndURL',    value: '%TITLE%\n%URL%' },
  { label: 'title',          value: '%TITLE%', map: ',y' },
  { label: 'anchor',         value: '<a href="%URL%">%TITLE%</a>' },
  { label: 'selanchor',      value: '<a href="%URL%" title="%TITLE%">%SEL%</a>' },
  { label: 'htmlblockquote', value: '<blockquote cite="%URL%" title="%TITLE%">%HTMLSEL%</blockquote>' },
  { label: 'hatena',		 value: '[%URL%:title]'},
  { label: 'hatenawithtitle',value: '%URL%:title=%TITLE%'},
  { label: 'ASIN',   value: 'copy ASIN code from Amazon', custom: function(){return content.document.getElementById('ASIN').value;} }
];
EOM

" localkeymode.js, stella.js
" stseek! +10がうまく動かないなぁ. -10なら動くんだけど.
let g:localkeymode_enable = "true"
js <<EOM
liberator.globalVariables.localKeyMappings=[
  [/^http:\/\/www\.(nicovideo\.jp|youtube\.com)\/watch/, [
    ['p', ':stplay'],
    ['m', ':stmute'],
    ['v', ':stcomment'],
    ['s', ':stseek! +10'],
    ['S', ':stseek! -10'],
    ['z', ':stlarge'],
  ]],
];
EOM

" feedSomeKeys_2.jsとlocalkeymode.jsの相性問題対応パッチ
" cf.http://vimperator.g.hatena.ne.jp/nokturnalmortum/20081220/1229773089
js <<EOM
autocommands.add(
  'VimperatorEnter',
  /.*/,
  function () {
    let (orig = plugins.LocalKeyMode.loadKeyMap) {
      plugins.LocalKeyMode.loadKeyMap = function () {
        if (!liberator.plugins.feedKey || liberator.plugins.feedKey.origMap.length <= 0)
          orig.call(plugins.LocalKeyMode);
      };
    }
  }
);
EOM

"" feedSomekeys_3.js
"command! -nargs=+ lazy autocmd VimperatorEnter .* <args>
"" Gmail
"lazy fmaps -u='^https?://mail\.google\.com/(mail|a)/' c / j k n p o u e x s r a # [ ] z ? gi gs gt gd ga gc gb
"" Livedoor Reader
"lazy fmaps -u='^http://(reader\.livedoor|fastladder)\.com/reader/' j k s a p v c z r < > <Space> <S-Space> q w e g
"" RememberTheMilk
"lazy fmaps -u='^https?://www\.rememberthemilk\.com/home/' j k m i n a x c t r d s ? d F,f G,g L,l Y,y H,h M,m z <Del> 0 1 2 3 4
"" Tumblr (use : ReblogCommand, TumblrTagCommand)
"lazy fmaps -u='^http://[^\./]*\.tumblr\.com/' i,t e,tk n,h
"fmap -urls='^http://[^\./]*\.tumblr\.com/' g g
"" はてなブックマーク
"lazy fmaps -u='^http://b\.hatena\.ne\.jp/(?!(entry|articles|guide))' j k o
"" Google Calendar
"lazy fmap -u='^http://www\.google\.com/calendar/' -event=keydown j k t a d w m x c e <Del> / + q s ?

" feedSomekeys_2.js
autocmd LocationChange .* :fmapc
autocmd LocationChange ^http://reader\\.livedoor\\.com/reader :fmap! j k s a r p o f v c <Space> <S-Space> < > T
" Tumblr (use : ReblogCommand, TumblrTagCommand)
" TagCommandを呼ぶg が2文字コマンドとバッティング. _3.jsを待つ
autocmd LocationChange ^http://.*\\.tumblr\\.com/ :fmap! i,t n,h g
" Gmail
" autocmd LocationChange ^https?://mail\\.google\\.com/mail :fmap! -depth 4 c / j k n p o u e x s r a # [ ] * z ? gi gs gt gd ga gc
autocmd LocationChange ^https?://mail\\.google\\.com/mail :fmap! c / j k n p o u e x s r a # [ ] * z ? gi gs gt gd ga gc gb
" Google Calendar
autocmd LocationChange ^http://www\\.google\\.com/calendar/ :fmap! -vkey -event keydown j k t a d w m x c e <Del> / + q s ?
" RememberTheMilk
autocmd LocationChange ^http://www\\.rememberthemilk\\.com/ :fmap j k m i n a x c t r d s ? d F,f G,g L,l Y,y H,h M,m z <Del> 0 1 2 3 4
" はてなブックマーク
autocmd LocationChange ^http://b\\.hatena\\.ne\\.jp(?!entry|articles|guide) :fmap! j k o

" removetabs.js
" 左側にあるタブを閉じる
noremap <C-S-Left> :removetabsleft
" 右側にあるタブを閉じる
noremap <C-S-Right> :removetabsright
" tabsort.js
command! urlsort tabsort -t=url
" _smooziee.js
" let g:smooziee_scroll_amount="10"
" let g:smooziee_scroll_interval="50"

" char-hints-mod2.js
" let g:hintchars="asdfjkl"
let g:hintsio="iO"
" let g:hintlabeling=""

" multi_requester.js
map ,mf :mr<Space>favotter-new<Space>termin<CR>

" toggler.js
" :toggle go で setting commands配列の次を実行する
" 元々は go: ["set go=","set go=rbT","set go=rb"],
" なんでgo= と記述されているのか分からない.
js <<EOM
liberator.globalVariables.toggler = {
  //  name: [ setting commands ]],
  // ツールバー
  go: ["set go=rbT","set go=rb"],
  // タブバー
  tab:["set showtabline=0", "set showtabline=2"],
  // サイドバー
  sb: ["sbclose","sbar Console"],
  go_and_sb: [
    ["set go=","sbclose"],
    ["set go=mTb","sbar Console"]
  ],
  //...
};
EOM

map <F2> :toggle go<CR>
map <F3> :toggle tab<CR>
map <F4> :toggle sb<CR>
" 再考したい
map ,1 :set go=rbT<CR>
map ,2 :set go=rb<CR>
" map <C-S-1> :set go="rbT"<CR>
" map <C-S-2> :set go="rb" <CR>
map ,q :set showtabline="2"<CR>
map ,w :set showtabline="0"<CR>
" travian のみでツールバーを表示する
autocmd LocationChange .* set go=rb
autocmd LocationChange ^http://s4.travian.jp/ set go=rbT

" はてなブックマーク拡張( http://subtech.g.hatena.ne.jp/secondlife/20090402/1238655382 )
javascript if (typeof hBookmark != 'undefined') liberator.loadScript('chrome://hatenabookmark/content/vimperator/plugin/hatenabookmark.js', {__proto__: this});

javascript <<EOF
// キーボードショートカットの指定
// 空(null)を指定すれば hints や nnoremap を上書きしなくなる
liberator.globalVariables.hBookmark_shortcuts = {
    hintsAdd     : 'c',
    hintsComment : 'C',
    add          : [''],
    comment      : [''],
};
// コマンドの設定
// 以下、はてブ拡張 ver. 1.2.4a1 以降で有効
/*
liberator.globalVariables.hBookmark_commands = {
        hbsearch             : 'hb[search]',
        hbsearch_tab         : 'hbt[absearch]',
        hbsearch_comment     : 'hbc[omment]',
        hbsearch_comment_tab : 'hbtc[omment]',
        hbsearch_url         : 'hbu[rl]',
        hbsearch_url_tab     : 'hbtu[rl]',
        hbsearch_title       : 'hbti[tle]',
        hbsearch_title_tab   : 'hbtti[tle]',
};
*/

// :hb! url 等の bang(!) 付きで開いた場合の挙動.
// 標準ははてブエントリーページを開く entryPage が設定されている.
// 他に新規タブで開く openNewTab がある.
// また、文字列ではなく自分で定義した関数をセットすることもできる.
liberator.globalVariables.hBookmark_bangFunction = 'entryPage';

// 検索時の wait(ms)
liberator.globalVariables.hBookmark_search_interval = 1000;
// 一度に検索する limit
liberator.globalVariables.hBookmark_search_limit = 10;
// 検索時の表示の最大件数. この件数に達するまで検索し続ける.
liberator.globalVariables.hBookmark_search_max_limit = 100;

EOF

" direct_bookmark.js
" let g:direct_sbm_use_services_by_tag="h"
" let g:direct_sbm_use_services_by_post="h"
" let g:direct_sbm_echo_type=""
" let g:direct_sbm_is_normalize=""
" let g:direct_sbm_is_usr_migemo=""

" ldrize_cooperation.js
let g:ldrc_captureMappings = "['j','k','p','o','?']"

" autopagerize_control.js
" let g:autopagerize_prevmap = "J" 
" let g:autopagerize_nextmap = "K"

" autocmd VimperatorEnter .* :set complete+=H
" はてブ検索
noremap C :hbt<Space>
" noremap cx :
" コメントのみ対象
noremap cc :hbtc<Space>
" titleのみ対象
noremap ct :hbtti<Space>
" urlのみ対象
noremap cu :hbtu<Space>

" entry_pageを表示する( exopen.js )
" label:
"   テンプレート名. コマンドの引数で指定してください.
" value:
"   OpenするURL
" custom:
"   関数か配列で指定してください.
"   関数の場合、return された文字列をオープンします.
"   配列の場合、value で指定された文字列を置換します. (条件→Array[0]、置換文字列→Array[1])
" description:
"   補完時に表示する説明文.
" newtab:
"   新規タブで開く場合は true を指定してください.
" escape:
"   URLエンコードする場合、true を指定してください.
javascript <<EOM
liberator.globalVariables.exopen_templates = [
{
  label: 'hatenaep',
  value: 'http://b.hatena.ne.jp/entry/%URL%',
  description: 'open hatena bookmark entrypage',
  newtab: true
}/*, {
  label: 'coderepos',
  value: 'http://coderepos.org/share/browser/lang/javascript/vimperator-plugins/trunk/',
  description: 'open coderepos vimperator-plugin page',
  newtab: true
} */
];
EOM

noremap <C-S-x> :exopen hatenaep<CR>

" no-reading.js
" let g:no_reading_do_echo = 1

" migrate_statusbar.js 
" ☆, feed, faviconをステータスラインに移動 
javascript <<EOM
liberator.globalVariables.migrate_elements = [
  {
      // star button of awesome bar
      id:    'star-button',
      dest:  'security-button',
      after: true,
  },
  {
      // icon that show the existence of RSS and Atom on current page
      id:    'feed-button',
      dest:  'security-button',
      after: true,
  },
  {
      // favicon of awesome bar
      id:    'page-proxy-stack',
      dest:  'liberator-statusline',
      after: false,
  },
];
EOM

" ----- その他 -----
" yourfilehost cookie削除
" cf.http://anond.hatelabo.jp/20100108213648
js <<EOM
commands.addUserCommand(
  ['removeCookieOfYourfile'],
  'removeCookieOfYourfile',
  function() {
    liberator.execute('cookiemanager remove yourfilehostdatabase.com/');
    liberator.execute('cookiemanager remove yourfilehost.com/');
    liberator.execute('cookiemanager remove yourlifehost.jp/');
        }
);
EOM

" フィードボタンをステータスラインに移動
" javascript <<EOM
" (function () {
"     var feedButton = document.getElementById('feed-button');
"         feedButton.parentNode.removeChild(feedButton);
"     var feedPanel  = document.createElement('statusbarpanel');
"         feedPanel.setAttribute('id', 'feed-panel-clone');
"         feedPanel.appendChild(feedButton.cloneNode(true));
"     document.getElementById('status-bar').insertBefore(
"         feedPanel,
"         document.getElementById('security-button')
"     );
" })();
" EOM

" 読み終わりましたわ
echo "vimp: ギギギ..."

" vim: set ft=vimperator:
